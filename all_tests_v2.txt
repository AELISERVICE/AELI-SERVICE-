
> aeli-services-backend@1.0.0 test
> cross-env NODE_ENV=test jest --runInBand

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

2026-02-14 14:47:07 [[31MERROR[39M]: 500 - Cannot read properties of undefined (reading 'catch') - /api/contacts - POST - ::ffff:127.0.0.1
2026-02-14 14:47:07 [[31MERROR[39M]: ERROR ≡ƒÆÑ Cannot read properties of undefined (reading 'catch')
2026-02-14 14:47:07 [[31MERROR[39M]: 500 - Cannot read properties of undefined (reading 'catch') - /api/contacts - POST - ::ffff:127.0.0.1
2026-02-14 14:47:07 [[31MERROR[39M]: ERROR ≡ƒÆÑ Cannot read properties of undefined (reading 'catch')
2026-02-14 14:47:09 [[31MERROR[39M]: CinetPay initialization error: MINIMUM_REQUIRED_FIELDS
2026-02-14 14:47:09 [[31MERROR[39M]: 500 - Request failed with status code 400 - /api/contacts/b97a80fe-97e1-4ef0-ba8d-0f69ae52f71d/unlock - POST - ::ffff:127.0.0.1
2026-02-14 14:47:09 [[31MERROR[39M]: ERROR ≡ƒÆÑ Request failed with status code 400
2026-02-14 14:47:09 [[33MWARN[39M]: Slow request: POST /api/contacts/b97a80fe-97e1-4ef0-ba8d-0f69ae52f71d/unlock took 2113ms
2026-02-14 14:47:09 [[31MERROR[39M]: 400 - Ce message est d├⌐j├á d├⌐bloqu├⌐ - /api/contacts/f7efa748-afec-4a4b-a422-1ae3e8368f66/unlock - POST - ::ffff:127.0.0.1
  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

node.exe : FAIL tests/integration/contacts-payper view.test.js (9.991 s)
At C:\Program Files\nodejs\npm.ps1:29 char:3
+   & $NODE_EXE $NPM_CLI_JS $args
+   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (FAIL tests/inte...st.js (9.991 s):String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
  Contact Pay-Per-View E2E Tests
    Contact Creation and Locking
      ├ù should create locked contact for provider WITHOUT subscription (130 ms)
      ├ù should auto-unlock contact for provider WITH active subscription (34 ms)
    Masked Data Retrieval
      ΓêÜ should return masked data for locked contacts (55 ms)
    Contact Unlock via Payment
      ΓêÜ should initiate unlock payment (2124 ms)
      ΓêÜ should reject unlock if already unlocked (25 ms)
      ΓêÜ should confirm unlock after successful payment (31 ms)

  ΓùÅ Contact Pay-Per-View E2E Tests ΓÇ║ Contact Creation and Locking ΓÇ║ should create locked contact for provider WITHOUT subscription

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 86 |[39m                 })[33m;[39m
     [90m 87 |[39m
    [31m[1m>[22m[39m[90m 88 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 89 |[39m
     [90m 90 |[39m             [90m// Check in database[39m
     [90m 91 |[39m             [36mconst[39m contact [33m=[39m [36mawait[39m [33mContact[39m[33m.[39mfindOne({[0m

      at Object.toBe (tests/integration/contacts-payper view.test.js:88:36)

  ΓùÅ Contact Pay-Per-View E2E Tests ΓÇ║ Contact Creation and Locking ΓÇ║ should auto-unlock contact for provider WITH active subscription

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 108 |[39m                 })[33m;[39m
     [90m 109 |[39m
    [31m[1m>[22m[39m[90m 110 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 111 |[39m
     [90m 112 |[39m             [90m// Check in database[39m
     [90m 113 |[39m             [36mconst[39m contact [33m=[39m [36mawait[39m [33mContact[39m[33m.[39mfindOne({[0m

      at Object.toBe (tests/integration/contacts-payper view.test.js:110:36)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

2026-02-14 14:47:12 [[31MERROR[39M]: 500 - Cannot read properties of undefined (reading 'catch') - /api/admin/providers/83e02998-868f-4257-a8c0-92b129173cf5/verify - PUT - ::ffff:127.0.0.1
2026-02-14 14:47:12 [[31MERROR[39M]: ERROR ≡ƒÆÑ Cannot read properties of undefined (reading 'catch')
2026-02-14 14:47:12 [[31MERROR[39M]: 500 - Cannot read properties of undefined (reading 'catch') - /api/admin/providers/83e02998-868f-4257-a8c0-92b129173cf5/feature - PUT - ::ffff:127.0.0.1
2026-02-14 14:47:12 [[31MERROR[39M]: ERROR ≡ƒÆÑ Cannot read properties of undefined (reading 'catch')
  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

FAIL tests/integration/admin.test.js
  Admin API
    GET /api/admin/stats
      ΓêÜ should reject unauthenticated request (8 ms)
      ΓêÜ should return platform statistics (48 ms)
    GET /api/admin/users
      ΓêÜ should reject unauthenticated request (8 ms)
      ΓêÜ should return list of users (19 ms)
    PUT /api/admin/users/:id/status
      ΓêÜ should reject unauthenticated request (11 ms)
      ΓêÜ should update user status (26 ms)
    GET /api/admin/providers/pending
      ΓêÜ should reject unauthenticated request (6 ms)
      ΓêÜ should return pending providers (27 ms)
    PUT /api/admin/providers/:id/verify
      ΓêÜ should reject unauthenticated request (8 ms)
      ├ù should verify a provider (26 ms)
    PUT /api/admin/providers/:id/feature
      ├ù should feature a provider (22 ms)
    GET /api/admin/providers/under-review
      ΓêÜ should return providers under review (19 ms)
    PUT /api/admin/providers/:id/review-documents
      ΓêÜ should update document review status (22 ms)
    GET /api/admin/audit-logs
      ΓêÜ should return audit logs (23 ms)
    GET /api/admin/reviews/reported
      ΓêÜ should reject unauthenticated request (5 ms)
    PUT /api/admin/reviews/:id/visibility
      ΓêÜ should reject unauthenticated request (6 ms)
      ΓêÜ should update review visibility (31 ms)

  ΓùÅ Admin API ΓÇ║ PUT /api/admin/providers/:id/verify ΓÇ║ should verify a provider

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 162 |[39m                 [33m.[39msend({ isVerified[33m:[39m [36mtrue[39m })[33m;[39m
     [90m 163 |[39m
    [31m[1m>[22m[39m[90m 164 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 165 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 166 |[39m
     [90m 167 |[39m             [36mconst[39m updatedProvider [33m=[39m [36mawait[39m 
[33mProvider[39m[33m.[39mfindByPk(testProvider[33m.[39mid)[33m;[39m[0m

      at Object.toBe (tests/integration/admin.test.js:164:36)

  ΓùÅ Admin API ΓÇ║ PUT /api/admin/providers/:id/feature ΓÇ║ should feature a provider

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 177 |[39m                 [33m.[39msend({ isFeatured[33m:[39m [36mtrue[39m })[33m;[39m
     [90m 178 |[39m
    [31m[1m>[22m[39m[90m 179 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 180 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 181 |[39m
     [90m 182 |[39m             [36mconst[39m updatedProvider [33m=[39m [36mawait[39m 
[33mProvider[39m[33m.[39mfindByPk(testProvider[33m.[39mid)[33m;[39m[0m

      at Object.toBe (tests/integration/admin.test.js:179:36)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

2026-02-14 14:47:15 [[31MERROR[39M]: 500 - Cannot read properties of undefined (reading 'catch') - /api/users/password - PUT - ::ffff:127.0.0.1
2026-02-14 14:47:15 [[31MERROR[39M]: ERROR ≡ƒÆÑ Cannot read properties of undefined (reading 'catch')
2026-02-14 14:47:15 [[31MERROR[39M]: 401 - Mot de passe actuel incorrect - /api/users/password - PUT - ::ffff:127.0.0.1
  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

FAIL tests/integration/users.test.js
  User API
    GET /api/users/profile
      ΓêÜ should return user profile (27 ms)
      ΓêÜ should reject unauthenticated request (6 ms)
    PUT /api/users/profile
      ΓêÜ should update user profile fields (25 ms)
    PUT /api/users/password
      ├ù should change user password (258 ms)
      ΓêÜ should reject incorrect current password (127 ms)
    DELETE /api/users/account
      ΓêÜ should deactivate user account (18 ms)

  ΓùÅ User API ΓÇ║ PUT /api/users/password ΓÇ║ should change user password

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 73 |[39m                 })[33m;[39m
     [90m 74 |[39m
    [31m[1m>[22m[39m[90m 75 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 76 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 77 |[39m
     [90m 78 |[39m             [90m// Verify we can login with new password (indirectly by checking DB if we wanted, [39m[0m

      at Object.toBe (tests/integration/users.test.js:75:36)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

2026-02-14 14:47:18 [[31MERROR[39M]: 500 - missing FROM-clause entry for table "services" - /api/providers?category=test-category-1771076837625 - GET - ::ffff:127.0.0.1
2026-02-14 14:47:18 [[31MERROR[39M]: ERROR ≡ƒÆÑ missing FROM-clause entry for table "services"
2026-02-14 14:47:18 [[31MERROR[39M]: 400 - Vous avez d├⌐j├á un profil prestataire - /api/providers/create - POST - ::ffff:127.0.0.1
  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

FAIL tests/integration/providers.test.js
  Providers API
    GET /api/providers
      ΓêÜ should return paginated providers list (20 ms)
      ΓêÜ should accept pagination parameters (14 ms)
      ΓêÜ should accept filter parameters (15 ms)
      ├ù should filter by category (84 ms)
      ΓêÜ should accept search parameter (12 ms)
      ΓêÜ should accept sort parameter (12 ms)
    GET /api/providers/:id
      ├ù should return 404 for non-existent provider (5 ms)
      ├ù should return provider details (6 ms)
    POST /api/providers/create
      ΓêÜ should reject unauthenticated request (16 ms)
      ΓêÜ should reject if user already has a provider profile (19 ms)
    PUT /api/providers/:id
      ΓêÜ should reject unauthenticated request (7 ms)
      ΓêÜ should update provider profile (17 ms)
    GET /api/providers/my-dashboard
      ΓêÜ should return provider dashboard data (22 ms)
      ΓêÜ should reject client access (11 ms)

  ΓùÅ Providers API ΓÇ║ GET /api/providers ΓÇ║ should filter by category

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 91 |[39m                 [33m.[39m[36mget[39m([32m`/api/providers?category=${testCategory.slug}`[39m)[33m;[39m
     [90m 92 |[39m
    [31m[1m>[22m[39m[90m 93 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 94 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 95 |[39m             [90m// Even if empty, it should exercise the category join logic[39m
     [90m 96 |[39m         })[33m;[39m[0m

      at Object.toBe (tests/integration/providers.test.js:93:36)

  ΓùÅ Providers API ΓÇ║ GET /api/providers/:id ΓÇ║ should return 404 for non-existent provider

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 401

    [0m [90m 118 |[39m                 [33m.[39m[36mget[39m([32m`/api/providers/${fakeId}`[39m)[33m;[39m
     [90m 119 |[39m
    [31m[1m>[22m[39m[90m 120 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 121 |[39m         })[33m;[39m
     [90m 122 |[39m
     [90m 123 |[39m         it([32m'should return provider details'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.toBe (tests/integration/providers.test.js:120:36)

  ΓùÅ Providers API ΓÇ║ GET /api/providers/:id ΓÇ║ should return provider details

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 125 |[39m                 [33m.[39m[36mget[39m([32m`/api/providers/${testProvider.id}`[39m)[33m;[39m
     [90m 126 |[39m
    [31m[1m>[22m[39m[90m 127 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 128 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 129 |[39m             
expect(res[33m.[39mbody[33m.[39mdata[33m.[39mprovider[33m.[39mid)[33m.[39mtoBe(testProvider[33m.[39mid)[33m;[39m
     [90m 130 |[39m         })[33m;[39m[0m

      at Object.toBe (tests/integration/providers.test.js:127:36)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

FAIL tests/unit/paymentController.test.js
  PaymentController Unit Tests
    initializePayment
      ΓêÜ should initialize payment for subscription (3 ms)
      ΓêÜ should throw error for invalid amount (60 ms)
    initializeNotchPayPayment
      ├ù should initialize NotchPay payment (2 ms)
    checkPaymentStatus
      ΓêÜ should return payment status (2 ms)
    getPaymentHistory
      ├ù should return client payment history
    getAllPayments
      ├ù should return all payments for admin
    handleNotchPayWebhook
      ΓêÜ should process accepted NotchPay webhook
    handleWebhook
      ΓêÜ should accept payment and trigger business logic (3 ms)
      ΓêÜ should handle refused payment from CinetPay (1 ms)

  ΓùÅ PaymentController Unit Tests ΓÇ║ initializeNotchPayPayment ΓÇ║ should initialize NotchPay payment

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

    [0m [90m 175 |[39m
     [90m 176 |[39m             expect([33mPayment[39m[33m.[39mcreate)[33m.[39mtoHaveBeenCalled()[33m;[39m
    [31m[1m>[22m[39m[90m 177 |[39m             expect(mockPayment[33m.[39msave)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m     |[39m                                      [31m[1m^[22m[39m
     [90m 178 |[39m             [90m// paymentUrl is set directly on payment object before save[39m
     [90m 179 |[39m             [36mconst[39m { i18nResponse } [33m=[39m require([32m'../../src/utils/helpers'[39m)[33m;[39m
     [90m 180 |[39m             expect(i18nResponse)[33m.[39mtoHaveBeenCalled()[33m;[39m[0m

      at Object.toHaveBeenCalled (tests/unit/paymentController.test.js:177:38)

  ΓùÅ PaymentController Unit Tests ΓÇ║ getPaymentHistory ΓÇ║ should return client payment history

    TypeError: Cannot destructure property 'limit' of 'getPaginationParams(...)' as it is undefined.

    [0m [90m 470 |[39m     [36mconst[39m userId [33m=[39m req[33m.[39muser[33m.[39mid[33m;[39m
     [90m 471 |[39m     [36mconst[39m { page [33m=[39m [35m1[39m[33m,[39m limit [33m=[39m [35m10[39m } [33m=[39m req[33m.[39mquery[33m;[39m
    [31m[1m>[22m[39m[90m 472 |[39m     [36mconst[39m { limit[33m:[39m queryLimit[33m,[39m offset } [33m=[39m getPaginationParams(page[33m,[39m 
limit)[33m;[39m
     [90m     |[39m                    [31m[1m^[22m[39m
     [90m 473 |[39m
     [90m 474 |[39m     [36mconst[39m { count[33m,[39m rows[33m:[39m payments } [33m=[39m [36mawait[39m 
[33mPayment[39m[33m.[39mfindAndCountAll({
     [90m 475 |[39m         where[33m:[39m { userId }[33m,[39m[0m

      at queryLimit (src/controllers/paymentController.js:472:20)
      at fn (tests/unit/paymentController.test.js:68:51)
      at Object.getPaymentHistory (tests/unit/paymentController.test.js:216:19)

  ΓùÅ PaymentController Unit Tests ΓÇ║ getAllPayments ΓÇ║ should return all payments for admin

    TypeError: Cannot destructure property 'limit' of 'getPaginationParams(...)' as it is undefined.

    [0m [90m 490 |[39m [36mconst[39m getAllPayments [33m=[39m asyncHandler([36masync[39m (req[33m,[39m res) [33m=>[39m {
     [90m 491 |[39m     [36mconst[39m { page [33m=[39m [35m1[39m[33m,[39m limit [33m=[39m [35m20[39m[33m,[39m status[33m,[39m type } 
[33m=[39m req[33m.[39mquery[33m;[39m
    [31m[1m>[22m[39m[90m 492 |[39m     [36mconst[39m { limit[33m:[39m queryLimit[33m,[39m offset } [33m=[39m getPaginationParams(page[33m,[39m 
limit)[33m;[39m
     [90m     |[39m                    [31m[1m^[22m[39m
     [90m 493 |[39m     [36mconst[39m where [33m=[39m {}[33m;[39m
     [90m 494 |[39m
     [90m 495 |[39m     [36mif[39m (status) where[33m.[39mstatus [33m=[39m status[33m;[39m[0m

      at queryLimit (src/controllers/paymentController.js:492:20)
      at fn (tests/unit/paymentController.test.js:68:51)
      at Object.getAllPayments (tests/unit/paymentController.test.js:233:19)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/integration/subscriptions.test.js (8.328 s)
  Subscription Integration Tests
    Subscription Model Methods
      Subscription.createTrial()
        ΓêÜ should create a 30-day trial subscription (382 ms)
        ΓêÜ should set currency to XAF (291 ms)
      Subscription.isActive()
        ΓêÜ should return true for active trial (278 ms)
        ΓêÜ should return false for expired subscription (270 ms)
        ΓêÜ should return false for provider without subscription (330 ms)
      Subscription.getStatus()
        ΓêÜ should return complete status for active trial (282 ms)
        ΓêÜ should return expired status for past subscription (260 ms)
        ΓêÜ should return none status for provider without subscription (339 ms)
      Subscription.renewSubscription()
        ΓêÜ should renew subscription with monthly plan (287 ms)
        ΓêÜ should throw error for trial plan renewal (279 ms)
        ΓêÜ should throw error for provider without subscription (307 ms)
      Subscription.expireOldSubscriptions()
        ΓêÜ should expire subscriptions past end date (302 ms)
        ΓêÜ should not expire active subscriptions (342 ms)
    PLANS pricing configuration
      ΓêÜ should have correct trial pricing (305 ms)
      ΓêÜ should have correct monthly pricing (337 ms)
      ΓêÜ should have correct quarterly pricing (308 ms)
      ΓêÜ should have correct yearly pricing (337 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    --- START TEST SETUP ---

      at Object.log (tests/integration/audit-logs.test.js:12:21)

  console.log
    Creating admin user...

      at Object.log (tests/integration/audit-logs.test.js:16:25)

  console.log
    --- END TEST SETUP ---

      at Object.log (tests/integration/audit-logs.test.js:27:21)

  console.log
    Running login test...

      at Object.log (tests/integration/audit-logs.test.js:36:21)

  console.log
    Login test PASSED

      at Object.log (tests/integration/audit-logs.test.js:61:21)

  console.log
    Running user status test...

      at Object.log (tests/integration/audit-logs.test.js:67:21)

  console.log
    User status test PASSED

      at Object.log (tests/integration/audit-logs.test.js:100:21)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/integration/audit-logs.test.js
  Audit Logging Integration
    Login Event
      ΓêÜ should log a login event (672 ms)
    Admin Actions
      ΓêÜ should log a user status update (662 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

2026-02-14 14:47:33 [[31MERROR[39M]: 401 - Email ou mot de passe incorrect - /api/auth/login - POST - ::ffff:127.0.0.1
2026-02-14 14:47:33 [[31MERROR[39M]: 401 - Email ou mot de passe incorrect - /api/auth/login - POST - ::ffff:127.0.0.1
  console.error
    Auth middleware error: jwt malformed

    [0m [90m 77 |[39m         next()[33m;[39m
     [90m 78 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 79 |[39m         console[33m.[39merror([32m'Auth middleware error:'[39m[33m,[39m error[33m.[39mmessage)[33m;[39m
     [90m    |[39m                 [31m[1m^[22m[39m
     [90m 80 |[39m
     [90m 81 |[39m         [36mif[39m (error[33m.[39mname [33m===[39m [32m'TokenExpiredError'[39m) {
     [90m 82 |[39m             [36mreturn[39m res[33m.[39mstatus([35m401[39m)[33m.[39mjson({[0m

      at error (src/middlewares/auth.js:79:17)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at router (node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/middlewares/i18n.js:93:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (src/app.js:121:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at urlencodedParser (node_modules/body-parser/lib/types/urlencoded.js:91:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at jsonParser (node_modules/body-parser/lib/types/json.js:113:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express-rate-limit/dist/index.cjs:807:7
      at node_modules/express-rate-limit/dist/index.cjs:691:5

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/integration/auth.test.js
  Auth API
    POST /api/auth/register
      ΓêÜ should register a new user and require OTP (298 ms)
      ΓêÜ should reject duplicate email (16 ms)
      ΓêÜ should validate required fields (9 ms)
    POST /api/auth/login
      ΓêÜ should require OTP for unverified email (260 ms)
      ΓêÜ should reject invalid credentials (144 ms)
      ΓêÜ should reject non-existent user (10 ms)
    POST /api/auth/forgot-password
      ΓêÜ should accept valid email (18 ms)
      ΓêÜ should not reveal if email exists (10 ms)
    GET /api/auth/me
      ΓêÜ should reject unauthenticated request (6 ms)
      ΓêÜ should reject invalid token (24 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

2026-02-14 14:47:36 [[32MINFO[39M]: Payment initialized: AELI177107685673958726
2026-02-14 14:47:36 [[31MERROR[39M]: 400 - Le montant doit ├¬tre un multiple de 5 - /api/payments/initialize - POST - ::ffff:127.0.0.1
2026-02-14 14:47:36 [[32MINFO[39M]: Webhook received for transaction: AELI177107685680910099
2026-02-14 14:47:36 [[32MINFO[39M]: Provider 41423c48-0808-4126-94b0-64d3ed06c042 boosted
2026-02-14 14:47:36 [[31MERROR[39M]: Error verifying payment AELI177107685680910099:
2026-02-14 14:47:37 [[32MINFO[39M]: NotchPay payment initialized: AELI177107685702143639
  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/integration/payments.test.js
  Payment API Integration
    POST /api/payments/initialize (CinetPay)
      ΓêÜ should initialize a CinetPay payment (94 ms)
      ΓêÜ should fail if amount is not a multiple of 5 (17 ms)
    POST /api/payments/webhook (CinetPay)
      ΓêÜ should process a successful CinetPay webhook (197 ms)
    POST /api/payments/notchpay/initialize
      ΓêÜ should initialize a NotchPay payment (58 ms)
    GET /api/admin/payments
      ΓêÜ should list all payments for admin (28 ms)
    GET /api/payments/history
      ΓêÜ should return client payment history (21 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

2026-02-14 14:47:39 [[31MERROR[39M]: 400 - D├⌐cision invalide. Choisissez: approved ou rejected - /api/admin/provider-applications/84a11288-f0ef-4e83-aed0-f9f1516e8400/review - PUT - ::ffff:127.0.0.1
  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/integration/provider-applications-admin.test.js
  Provider Application Admin API
    PUT /api/admin/provider-applications/:id/review
      ΓêÜ should approve a provider application (67 ms)
      ΓêÜ should reject if decision is invalid (15 ms)
    GET /api/admin/provider-applications
      ΓêÜ should list provider applications (25 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/integration/health.test.js
  API Health
    GET /api/health
      ΓêÜ should return health status (11 ms)
    Public endpoints
      ΓêÜ should list categories without auth (25 ms)
      ΓêÜ should list providers without auth (18 ms)
    Protected endpoints
      ΓêÜ should reject favorites without auth (8 ms)
      ΓêÜ should reject admin routes without auth (8 ms)
    Rate limiting
      ΓêÜ should include rate limit headers (8 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/integration/services.test.js
  Services API
    GET /api/services/categories
      ΓêÜ should return list of categories (29 ms)
    GET /api/services/provider/:providerId
      ΓêÜ should return empty array for non-existent provider (18 ms)
    POST /api/services/categories
      ΓêÜ should reject unauthenticated request (16 ms)
    POST /api/services
      ΓêÜ should reject unauthenticated request (8 ms)
    PUT /api/services/:id
      ΓêÜ should reject unauthenticated request (9 ms)
    DELETE /api/services/:id
      ΓêÜ should reject unauthenticated request (7 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

2026-02-14 14:47:46 [[31MERROR[39M]: 400 - La carte nationale d'identit├⌐ (CNI) est obligatoire - /api/providers/apply - POST - ::ffff:127.0.0.1
  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/integration/provider-applications.test.js
  Provider Application Integration
    POST /api/providers/apply
      ΓêÜ should require CNI files (44 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/integration/favorites.test.js
  Favorites API
    GET /api/favorites
      ΓêÜ should reject unauthenticated request (12 ms)
    POST /api/favorites
      ΓêÜ should reject unauthenticated request (17 ms)
    DELETE /api/favorites/:providerId
      ΓêÜ should reject unauthenticated request (9 ms)
    GET /api/favorites/check/:providerId
      ΓêÜ should reject unauthenticated request (8 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

2026-02-14 14:47:52 [[31MERROR[39M]: 404 - Prestataire non trouv├⌐ - /api/contacts - POST - ::ffff:127.0.0.1
  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/integration/contacts.test.js
  Contacts API
    POST /api/contacts
      ΓêÜ should create contact without authentication (33 ms)
      ΓêÜ should validate required fields (10 ms)
      ΓêÜ should validate email format (12 ms)
    GET /api/contacts/received
      ΓêÜ should reject unauthenticated request (10 ms)
    GET /api/contacts/sent
      ΓêÜ should reject unauthenticated request (10 ms)
    PUT /api/contacts/:id/status
      ΓêÜ should reject unauthenticated request (11 ms)
    ≡ƒÆ░ Pay-Per-View System
      POST /api/contacts/:id/unlock
        ΓêÜ should reject unauthenticated request (8 ms)
        ΓêÜ should reject non-provider users
        ΓêÜ should return 404 for non-existent contact
      POST /api/contacts/:id/unlock/confirm
        ΓêÜ should reject unauthenticated request (10 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/integration/reviews.test.js
  Reviews API
    GET /api/reviews/provider/:providerId
      ΓêÜ should return empty array for non-existent provider (22 ms)
      ΓêÜ should accept pagination parameters (14 ms)
    POST /api/reviews
      ΓêÜ should reject unauthenticated request (16 ms)
    PUT /api/reviews/:id
      ΓêÜ should reject unauthenticated request (9 ms)
    DELETE /api/reviews/:id
      ΓêÜ should reject unauthenticated request (10 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/middlewares.test.js
  Middlewares Unit Tests
    Audit Middleware
      ΓêÜ should log an audit event correctly (126 ms)
    IP Banlist Middleware
      ΓêÜ should pass for non-banned IP (15 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/validators.test.js
  Validators
    Password Validation Rules
      ΓêÜ should accept valid strong password (1 ms)
      ΓêÜ should reject password without uppercase
      ΓêÜ should reject password without lowercase (1 ms)
      ΓêÜ should reject password without number
      ΓêÜ should reject password too short
    Email Validation Rules
      ΓêÜ should validate correct email format (1 ms)
      ΓêÜ should reject invalid email formats (1 ms)
    Phone Validation Rules
      ΓêÜ should validate Cameroon phone numbers
      ΓêÜ should reject invalid phone numbers
    UUID Validation
      ΓêÜ should validate correct UUIDs
      ΓêÜ should reject invalid UUIDs
    Rating Validation
      ΓêÜ should accept ratings between 1 and 5 (1 ms)
      ΓêÜ should reject ratings outside 1-5 range (1 ms)
      ΓêÜ should accept decimal ratings (1 ms)
    Price Validation
      ΓêÜ should accept positive prices (1 ms)
      ΓêÜ should accept zero price (free services)
      ΓêÜ should reject negative prices (1 ms)
    Subscription Plan Validation
      ΓêÜ should validate allowed plan types
      ΓêÜ should reject invalid plan types
    Payment Status Validation
      ΓêÜ should validate allowed payment statuses (1 ms)
      ΓêÜ should reject invalid payment status

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/integration/adminStats.test.js
  Admin Stats Optimization
    Query Optimization
      ΓêÜ should use grouped query for user stats (1 ms)
      ΓêÜ should use conditional aggregates for provider stats
      ΓêÜ should combine review count and average in single query (1 ms)
      ΓêÜ should use grouped query for contact stats by status
      ΓêÜ should use grouped query for payment stats with amounts
    Stats Processing
      ΓêÜ should correctly sum total users from grouped stats
      ΓêÜ should correctly process payment stats with amounts (1 ms)
      ΓêÜ should handle empty stats gracefully (1 ms)
      ΓêÜ should calculate total payments correctly (1 ms)
    Performance Verification
      ΓêÜ should execute 8 queries in parallel instead of 19 sequential (1 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/emailTemplates.test.js
  Email Templates
    welcomeEmail
      ΓêÜ should generate welcome email for client (2 ms)
      ΓêÜ should generate welcome email for provider (1 ms)
    newContactEmail
      ΓêÜ should generate contact email with phone (1 ms)
    accountVerifiedEmail
      ΓêÜ should generate verification email (1 ms)
    documentsReceivedEmail
      ΓêÜ should generate documents received email (1 ms)
    documentsRejectedEmail
      ΓêÜ should generate rejection email with reasons (1 ms)
    paymentSuccessEmail
      ΓêÜ should generate payment success email (1 ms)
    paymentFailedEmail
      ΓêÜ should generate payment failed email (1 ms)
    otpEmail
      ΓêÜ should generate OTP email (1 ms)
    passwordResetEmail
      ΓêÜ should generate password reset email

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/security.test.js
  Security Middleware
    Constants
      ΓêÜ MAX_FAILED_ATTEMPTS should be 5 (3 ms)
      ΓêÜ MAX_OTP_ATTEMPTS should be 3 (1 ms)
      ΓêÜ LOCKOUT_DURATION_MINUTES should be 30 (1 ms)
    handleFailedLogin()
      ΓêÜ should increment failed login attempts (1 ms)
      ΓêÜ should lock account after MAX_FAILED_ATTEMPTS (1 ms)
      ΓêÜ should log security event for failed login (1 ms)
      ΓêÜ should log high risk event when account is locked (1 ms)
      ΓêÜ should set correct lockout duration
    handleSuccessfulLogin()
      ΓêÜ should reset failed login attempts to 0
      ΓêÜ should clear lockedUntil (1 ms)
      ΓêÜ should update lastLogin timestamp (1 ms)
      ΓêÜ should update lastActivity timestamp
      ΓêÜ should log successful login event (1 ms)
    handleFailedOTP()
      ΓêÜ should increment OTP attempts
      ΓêÜ should return true if retries allowed
      ΓêÜ should return false and invalidate OTP after MAX_OTP_ATTEMPTS (1 ms)
      ΓêÜ should log failed OTP event (1 ms)
      ΓêÜ should increase risk level as attempts increase
    handleSuccessfulOTP()
      ΓêÜ should set isEmailVerified to true (1 ms)
      ΓêÜ should clear OTP fields (1 ms)
      ΓêÜ should log successful OTP verification (1 ms)
    logSecurityEvent()
      ΓêÜ should log event with correct parameters
      ΓêÜ should use default values when not provided (1 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.error
    Decryption error: Unsupported state or unable to authenticate data

    [0m [90m  98 |[39m         [36mreturn[39m decrypted[33m;[39m
     [90m  99 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 100 |[39m         console[33m.[39merror([32m'Decryption error:'[39m[33m,[39m error[33m.[39mmessage)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 101 |[39m         [90m// Return original if decryption fails (might be plain text)[39m
     [90m 102 |[39m         [36mreturn[39m encryptedText[33m;[39m
     [90m 103 |[39m     }[0m

      at Object.error [as decrypt] (src/utils/encryption.js:100:17)
      at Object.decrypt (tests/unit/encryption.test.js:242:39)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/encryption.test.js
  Encryption Utility
    encrypt()
      ΓêÜ should encrypt a plain text string (2 ms)
      ΓêÜ should return different ciphertexts for same input (random IV) (1 ms)
      ΓêÜ should return null/undefined for null input (1 ms)
      ΓêÜ should return undefined for undefined input (1 ms)
      ΓêÜ should return non-string values as-is (1 ms)
      ΓêÜ should handle empty string (1 ms)
      ΓêÜ should handle special characters (1 ms)
      ΓêÜ should handle long strings (2 ms)
    decrypt()
      ΓêÜ should decrypt an encrypted string back to original (1 ms)
      ΓêÜ should return non-encrypted strings as-is (1 ms)
      ΓêÜ should return null for null input (1 ms)
      ΓêÜ should return undefined for undefined input (1 ms)
      ΓêÜ should handle encrypted special characters (1 ms)
      ΓêÜ should handle encrypted long strings (1 ms)
      ΓêÜ should return original for invalid format (wrong number of parts) (1 ms)
    isEncrypted()
      ΓêÜ should return true for encrypted string (1 ms)
      ΓêÜ should return false for plain string
      ΓêÜ should return false for null (1 ms)
      ΓêÜ should return false for undefined (1 ms)
      ΓêÜ should return false for non-string values (1 ms)
      ΓêÜ should return false for string with colons but not hex (1 ms)
    encryptIfNeeded()
      ΓêÜ should encrypt plain text (1 ms)
      ΓêÜ should not double-encrypt already encrypted text (2 ms)
      ΓêÜ should return null for null input (1 ms)
      ΓêÜ should return undefined for undefined input (1 ms)
    createBlindIndex()
      ΓêÜ should create a deterministic hash for same input (2 ms)
      ΓêÜ should create different hashes for different inputs (1 ms)
      ΓêÜ should be case-insensitive (1 ms)
      ΓêÜ should trim whitespace (1 ms)
      ΓêÜ should return null for null input (1 ms)
      ΓêÜ should return null for empty string (1 ms)
    generateEncryptionKey()
      ΓêÜ should generate a 32-character key (1 ms)
      ΓêÜ should generate unique keys (1 ms)
      ΓêÜ should generate hex-compatible key (1 ms)
    Error Handling
      ΓêÜ should handle decryption with tampered ciphertext gracefully (12 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/helpers.test.js
  Helpers Utility Functions
    successResponse
      ΓêÜ should return success response with data (2 ms)
      ΓêÜ should return success response without data (1 ms)
    getPaginationParams
      ΓêÜ should return correct limit and offset (1 ms)
      ΓêÜ should handle string inputs (1 ms)
      ΓêÜ should cap limit at 50
      ΓêÜ should use defaults for invalid inputs (1 ms)
    getPaginationData
      ΓêÜ should calculate pagination correctly (1 ms)
      ΓêÜ should handle last page
      ΓêÜ should handle single page (1 ms)
      ΓêÜ should handle zero items
    buildSortOrder
      ΓêÜ should build sort order for common fields (1 ms)
      ΓêÜ should default to recent for unknown sort
    parseBoolean
      ΓêÜ should parse true values
      ΓêÜ should parse false values
      ΓêÜ should return undefined for invalid inputs (2 ms)
    extractPhotoUrls
      ΓêÜ should extract URLs from uploaded files
      ΓêÜ should return empty array for no files

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/admin_validators.test.js
  Admin Validators
    updateUserStatusValidation
      ΓêÜ should pass for valid input (2 ms)
      ΓêÜ should fail for invalid UUID
      ΓêÜ should fail for non-boolean isActive (1 ms)
    verifyProviderValidation
      ΓêÜ should fail for invalid UUID (1 ms)
    featureProviderValidation
      ΓêÜ should fail for invalid isFeatured (1 ms)
    updateReviewVisibilityValidation
      ΓêÜ should pass for valid input (1 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/i18n.test.js
  i18n Middleware
    detectLanguage
      ΓêÜ should detect language from query parameter (1 ms)
      ΓêÜ should detect language from Accept-Language header (1 ms)
      ΓêÜ should prioritize query param over header
      ΓêÜ should default to French for unsupported languages (1 ms)
      ΓêÜ should default to French when no language specified
      ΓêÜ should handle complex Accept-Language header (1 ms)
    t (translation function)
      ΓêÜ should translate French keys (1 ms)
      ΓêÜ should translate English keys
      ΓêÜ should replace parameters
      ΓêÜ should return key for missing translation (1 ms)
      ΓêÜ should fallback to French for unsupported locale
      ΓêÜ should handle nested keys (1 ms)
    i18nMiddleware
      ΓêÜ should add locale and t function to request (1 ms)
      ΓêÜ should make t function work correctly (1 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/responseHelpers.test.js
  Response Helpers
    getPaginationParams
      ΓêÜ should return default values for page 1 (1 ms)
      ΓêÜ should calculate correct offset for page 2
      ΓêÜ should calculate correct offset for page 3 with limit 20 (1 ms)
      ΓêÜ should handle string inputs
      ΓêÜ should enforce maximum limit of 50
      ΓêÜ should enforce minimum limit of 1
      ΓêÜ should use default values when not provided
    getPaginationData
      ΓêÜ should calculate total pages correctly (1 ms)
      ΓêÜ should handle exact page divisions
      ΓêÜ should indicate hasNextPage correctly
      ΓêÜ should indicate hasPrevPage correctly (1 ms)
      ΓêÜ should handle empty results (1 ms)
    buildSortOrder
      ΓêÜ should return recent sort (snake_case) by default
      ΓêÜ should handle rating sort (1 ms)
      ΓêÜ should handle views sort
      ΓêÜ should handle name sort
      ΓêÜ should handle unknown sort with default (1 ms)
    formatPrice
      ΓêÜ should format XAF currency (2 ms)
      ΓêÜ should return "Sur demande" for zero/null (1 ms)
      ΓêÜ should handle large amounts (1 ms)
    extractPhotoUrls
      ΓêÜ should extract path from files array
      ΓêÜ should handle empty files array
      ΓêÜ should handle undefined files (1 ms)
      ΓêÜ should fallback to secure_url if path missing
    cleanPhoneNumber
      ΓêÜ should remove spaces and dashes
      ΓêÜ should handle null/undefined
    parseBoolean
      ΓêÜ should parse truthy values (8 ms)
      ΓêÜ should parse falsy values
      ΓêÜ should return undefined for invalid values

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/database.test.js
  Database Configuration
    Pool Configuration
      ΓêÜ should have environment-specific pool settings (3 ms)
      ΓêÜ should use correct pool for each environment (2 ms)
      ΓêÜ should default to development config for unknown environments (1 ms)
    Connection Retry Logic
      ΓêÜ should retry connection on transient failures (1 ms)
      ΓêÜ should implement exponential backoff (1 ms)
      ΓêÜ should exit process after max retries (non-test env) (1 ms)
    Dialect Options
      ΓêÜ should enable SSL in production (1 ms)
      ΓêÜ should have no SSL in development (1 ms)
      ΓêÜ should set statement timeout in production
    Pool Statistics
      ΓêÜ should provide pool stats structure (2 ms)
      ΓêÜ should calculate pool utilization (1 ms)
    Connection Validation
      ΓêÜ should validate connection objects (1 ms)
    Retry Error Matching
      ΓêÜ should identify retryable errors (11 ms)

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/cors_parsing.test.js
  CORS Configuration Parsing
    ΓêÜ should parse single URL correctly (2 ms)
    ΓêÜ should parse comma-separated URLs correctly (1 ms)
    ΓêÜ should parse JSON array URLs correctly (1 ms)
    ΓêÜ should handle spaces in JSON array
    ΓêÜ should fallback to default origins if empty

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/providerController.test.js
  Provider Controller Logic
    Provider Creation
      ΓêÜ should create provider with trial subscription (1 ms)
      ΓêÜ should invalidate cache after creation (1 ms)
    Provider Retrieval
      ΓêÜ should return cached data if available
      ΓêÜ should fetch from database if not cached (1 ms)
      ΓêÜ should include related data in provider details
    Subscription Status Check
      ΓêÜ should hide contact info when subscription expired (1 ms)
      ΓêÜ should show full data when subscription active
      ΓêÜ should apply shorter cache TTL for expired subscriptions (1 ms)
    Provider Filters and Pagination
      ΓêÜ should apply location filter with case-insensitive search
      ΓêÜ should apply minimum rating filter (1 ms)
      ΓêÜ should apply category filter via service relation
    Provider Dashboard Stats
      ΓêÜ should return correct stats structure (1 ms)
    Document Upload Validation
      ΓêÜ should validate allowed document types
      ΓêÜ should enforce max 5 documents limit (1 ms)
      ΓêÜ should prevent document deletion after verification

  console.log
    Γ£à Test database connected

      at Object.log (tests/setup.js:17:17)

  console.log
    Γ£à Test database connection closed

      at Object.log (tests/setup.js:30:17)

PASS tests/unit/dbHelpers.test.js
  Database Helpers Logic
    batchInsert Logic
      ΓêÜ should chunk records correctly (3 ms)
      ΓêÜ should handle empty array (1 ms)
      ΓêÜ should handle single chunk when records less than chunk size (1 ms)
    safeFindOrCreate Logic
      ΓêÜ should handle race condition recovery (1 ms)
    Transaction Retry Logic
      ΓêÜ should identify deadlock errors
      ΓêÜ should implement exponential backoff
    Transaction Options
      ΓêÜ should support SERIALIZABLE isolation level (1 ms)

Summary of all failing tests
FAIL tests/integration/contacts-payper view.test.js (9.991 s)
  ΓùÅ Contact Pay-Per-View E2E Tests ΓÇ║ Contact Creation and Locking ΓÇ║ should create locked contact for provider WITHOUT subscription

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 86 |[39m                 })[33m;[39m
     [90m 87 |[39m
    [31m[1m>[22m[39m[90m 88 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 89 |[39m
     [90m 90 |[39m             [90m// Check in database[39m
     [90m 91 |[39m             [36mconst[39m contact [33m=[39m [36mawait[39m [33mContact[39m[33m.[39mfindOne({[0m

      at Object.toBe (tests/integration/contacts-payper view.test.js:88:36)

  ΓùÅ Contact Pay-Per-View E2E Tests ΓÇ║ Contact Creation and Locking ΓÇ║ should auto-unlock contact for provider WITH active subscription

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 108 |[39m                 })[33m;[39m
     [90m 109 |[39m
    [31m[1m>[22m[39m[90m 110 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 111 |[39m
     [90m 112 |[39m             [90m// Check in database[39m
     [90m 113 |[39m             [36mconst[39m contact [33m=[39m [36mawait[39m [33mContact[39m[33m.[39mfindOne({[0m

      at Object.toBe (tests/integration/contacts-payper view.test.js:110:36)

FAIL tests/integration/admin.test.js
  ΓùÅ Admin API ΓÇ║ PUT /api/admin/providers/:id/verify ΓÇ║ should verify a provider

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 162 |[39m                 [33m.[39msend({ isVerified[33m:[39m [36mtrue[39m })[33m;[39m
     [90m 163 |[39m
    [31m[1m>[22m[39m[90m 164 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 165 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 166 |[39m
     [90m 167 |[39m             [36mconst[39m updatedProvider [33m=[39m [36mawait[39m 
[33mProvider[39m[33m.[39mfindByPk(testProvider[33m.[39mid)[33m;[39m[0m

      at Object.toBe (tests/integration/admin.test.js:164:36)

  ΓùÅ Admin API ΓÇ║ PUT /api/admin/providers/:id/feature ΓÇ║ should feature a provider

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 177 |[39m                 [33m.[39msend({ isFeatured[33m:[39m [36mtrue[39m })[33m;[39m
     [90m 178 |[39m
    [31m[1m>[22m[39m[90m 179 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 180 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 181 |[39m
     [90m 182 |[39m             [36mconst[39m updatedProvider [33m=[39m [36mawait[39m 
[33mProvider[39m[33m.[39mfindByPk(testProvider[33m.[39mid)[33m;[39m[0m

      at Object.toBe (tests/integration/admin.test.js:179:36)

FAIL tests/integration/users.test.js
  ΓùÅ User API ΓÇ║ PUT /api/users/password ΓÇ║ should change user password

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 73 |[39m                 })[33m;[39m
     [90m 74 |[39m
    [31m[1m>[22m[39m[90m 75 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 76 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 77 |[39m
     [90m 78 |[39m             [90m// Verify we can login with new password (indirectly by checking DB if we wanted, [39m[0m

      at Object.toBe (tests/integration/users.test.js:75:36)

FAIL tests/integration/providers.test.js
  ΓùÅ Providers API ΓÇ║ GET /api/providers ΓÇ║ should filter by category

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

    [0m [90m 91 |[39m                 [33m.[39m[36mget[39m([32m`/api/providers?category=${testCategory.slug}`[39m)[33m;[39m
     [90m 92 |[39m
    [31m[1m>[22m[39m[90m 93 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 94 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 95 |[39m             [90m// Even if empty, it should exercise the category join logic[39m
     [90m 96 |[39m         })[33m;[39m[0m

      at Object.toBe (tests/integration/providers.test.js:93:36)

  ΓùÅ Providers API ΓÇ║ GET /api/providers/:id ΓÇ║ should return 404 for non-existent provider

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 401

    [0m [90m 118 |[39m                 [33m.[39m[36mget[39m([32m`/api/providers/${fakeId}`[39m)[33m;[39m
     [90m 119 |[39m
    [31m[1m>[22m[39m[90m 120 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 121 |[39m         })[33m;[39m
     [90m 122 |[39m
     [90m 123 |[39m         it([32m'should return provider details'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.toBe (tests/integration/providers.test.js:120:36)

  ΓùÅ Providers API ΓÇ║ GET /api/providers/:id ΓÇ║ should return provider details

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 401

    [0m [90m 125 |[39m                 [33m.[39m[36mget[39m([32m`/api/providers/${testProvider.id}`[39m)[33m;[39m
     [90m 126 |[39m
    [31m[1m>[22m[39m[90m 127 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                                    [31m[1m^[22m[39m
     [90m 128 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 129 |[39m             
expect(res[33m.[39mbody[33m.[39mdata[33m.[39mprovider[33m.[39mid)[33m.[39mtoBe(testProvider[33m.[39mid)[33m;[39m
     [90m 130 |[39m         })[33m;[39m[0m

      at Object.toBe (tests/integration/providers.test.js:127:36)

FAIL tests/unit/paymentController.test.js
  ΓùÅ PaymentController Unit Tests ΓÇ║ initializeNotchPayPayment ΓÇ║ should initialize NotchPay payment

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

    [0m [90m 175 |[39m
     [90m 176 |[39m             expect([33mPayment[39m[33m.[39mcreate)[33m.[39mtoHaveBeenCalled()[33m;[39m
    [31m[1m>[22m[39m[90m 177 |[39m             expect(mockPayment[33m.[39msave)[33m.[39mtoHaveBeenCalled()[33m;[39m
     [90m     |[39m                                      [31m[1m^[22m[39m
     [90m 178 |[39m             [90m// paymentUrl is set directly on payment object before save[39m
     [90m 179 |[39m             [36mconst[39m { i18nResponse } [33m=[39m require([32m'../../src/utils/helpers'[39m)[33m;[39m
     [90m 180 |[39m             expect(i18nResponse)[33m.[39mtoHaveBeenCalled()[33m;[39m[0m

      at Object.toHaveBeenCalled (tests/unit/paymentController.test.js:177:38)

  ΓùÅ PaymentController Unit Tests ΓÇ║ getPaymentHistory ΓÇ║ should return client payment history

    TypeError: Cannot destructure property 'limit' of 'getPaginationParams(...)' as it is undefined.

    [0m [90m 470 |[39m     [36mconst[39m userId [33m=[39m req[33m.[39muser[33m.[39mid[33m;[39m
     [90m 471 |[39m     [36mconst[39m { page [33m=[39m [35m1[39m[33m,[39m limit [33m=[39m [35m10[39m } [33m=[39m req[33m.[39mquery[33m;[39m
    [31m[1m>[22m[39m[90m 472 |[39m     [36mconst[39m { limit[33m:[39m queryLimit[33m,[39m offset } [33m=[39m getPaginationParams(page[33m,[39m 
limit)[33m;[39m
     [90m     |[39m                    [31m[1m^[22m[39m
     [90m 473 |[39m
     [90m 474 |[39m     [36mconst[39m { count[33m,[39m rows[33m:[39m payments } [33m=[39m [36mawait[39m 
[33mPayment[39m[33m.[39mfindAndCountAll({
     [90m 475 |[39m         where[33m:[39m { userId }[33m,[39m[0m

      at queryLimit (src/controllers/paymentController.js:472:20)
      at fn (tests/unit/paymentController.test.js:68:51)
      at Object.getPaymentHistory (tests/unit/paymentController.test.js:216:19)

  ΓùÅ PaymentController Unit Tests ΓÇ║ getAllPayments ΓÇ║ should return all payments for admin

    TypeError: Cannot destructure property 'limit' of 'getPaginationParams(...)' as it is undefined.

    [0m [90m 490 |[39m [36mconst[39m getAllPayments [33m=[39m asyncHandler([36masync[39m (req[33m,[39m res) [33m=>[39m {
     [90m 491 |[39m     [36mconst[39m { page [33m=[39m [35m1[39m[33m,[39m limit [33m=[39m [35m20[39m[33m,[39m status[33m,[39m type } 
[33m=[39m req[33m.[39mquery[33m;[39m
    [31m[1m>[22m[39m[90m 492 |[39m     [36mconst[39m { limit[33m:[39m queryLimit[33m,[39m offset } [33m=[39m getPaginationParams(page[33m,[39m 
limit)[33m;[39m
     [90m     |[39m                    [31m[1m^[22m[39m
     [90m 493 |[39m     [36mconst[39m where [33m=[39m {}[33m;[39m
     [90m 494 |[39m
     [90m 495 |[39m     [36mif[39m (status) where[33m.[39mstatus [33m=[39m status[33m;[39m[0m

      at queryLimit (src/controllers/paymentController.js:492:20)
      at fn (tests/unit/paymentController.test.js:68:51)
      at Object.getAllPayments (tests/unit/paymentController.test.js:233:19)


Test Suites: 5 failed, 25 passed, 30 total
Tests:       11 failed, 318 passed, 329 total
Snapshots:   0 total
Time:        63.117 s, estimated 68 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
