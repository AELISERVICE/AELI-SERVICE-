paths:
  /admin/stats:
    get:
      tags:
        - Admin
      summary: Statistiques de la plateforme
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Statistiques globales
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      users:
                        type: object
                        properties:
                          total:
                            type: integer
                          clients:
                            type: integer
                          providers:
                            type: integer
                      providers:
                        type: object
                        properties:
                          total:
                            type: integer
                          active:
                            type: integer
                          pending:
                            type: integer
                          featured:
                            type: integer
                      services:
                        type: object
                        properties:
                          total:
                            type: integer
                      reviews:
                        type: object
                        properties:
                          total:
                            type: integer
                          averageRating:
                            type: string
                      contacts:
                        type: object
                        properties:
                          total:
                            type: integer
                          pending:
                            type: integer
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /admin/users:
    get:
      tags:
        - Admin
      summary: Liste des utilisateurs
      description: |
        Récupère la liste paginée des utilisateurs.
        **Les administrateurs sont exclus par défaut.**
        Si un rôle spécifique est précisé via le paramètre `role`, seuls les utilisateurs de ce rôle sont retournés.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
        - in: query
          name: limit
          schema:
            type: integer
        - in: query
          name: role
          schema:
            type: string
            enum: [client, provider]
          description: Filtre par rôle (admins exclus par défaut)
        - in: query
          name: search
          schema:
            type: string
          description: Recherche par nom, prénom ou email
      responses:
        '200':
          description: Liste des utilisateurs (sans les admins par défaut)

  /admin/users/{id}/status:
    put:
      tags:
        - Admin
      summary: Activer/désactiver un compte
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - isActive
              properties:
                isActive:
                  type: boolean
      responses:
        '200':
          description: Statut mis à jour

  /admin/provider-applications:
    get:
      tags:
        - Admin
      summary: Liste des candidatures prestataires
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
        - in: query
          name: limit
          schema:
            type: integer
        - in: query
          name: status
          schema:
            type: string
            enum: [pending, approved, rejected]
          description: Filtrer par statut
      responses:
        '200':
          description: Liste des candidatures

  /admin/provider-applications/{id}:
    get:
      tags:
        - Admin
      summary: Détail d'une candidature
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Détails de la candidature
        '404':
          description: Candidature non trouvée

  /admin/provider-applications/{id}/review:
    put:
      tags:
        - Admin
      summary: Approuver/Rejeter une candidature
      description: |
        Décision finale sur une candidature prestataire.
        - Si `decision: approved` → change le rôle client→provider, crée le profil, abonnement d'essai 30j, email de félicitations (transaction atomique)
        - Si `decision: rejected` → `rejectionReason` est **obligatoire**, email de rejet envoyé
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - decision
              properties:
                decision:
                  type: string
                  enum: [approved, rejected]
                rejectionReason:
                  type: string
                  description: Obligatoire si decision=rejected
                adminNotes:
                  type: string
                  description: Notes internes de l'admin
            examples:
              approval:
                summary: Approbation
                value:
                  decision: approved
                  adminNotes: "Dossier complet, profil vérifié"
              rejection:
                summary: Rejet
                value:
                  decision: rejected
                  rejectionReason: "CNI illisible, veuillez resoumettre une photo claire"
                  adminNotes: "Photo floue, demander un scan"
      responses:
        '200':
          description: Candidature traitée
        '400':
          description: Décision invalide ou motif de rejet manquant

  /admin/providers/pending:
    get:
      tags:
        - Admin
      summary: Prestataires en attente de validation
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
        - in: query
          name: limit
          schema:
            type: integer
      responses:
        '200':
          description: Liste des prestataires en attente

  /admin/providers/{id}/verify:
    put:
      tags:
        - Admin
      summary: Valider/rejeter un prestataire
      description: |
        Valide ou retire le statut vérifié d'un prestataire existant.
        - Si `isVerified: true` → le prestataire reçoit le badge vérifié + email de confirmation
        - Si `isVerified: false` → le champ `rejectionReason` est **obligatoire** (5-500 caractères) + email de notification avec le motif
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - isVerified
              properties:
                isVerified:
                  type: boolean
                  description: true pour valider, false pour rejeter
                rejectionReason:
                  type: string
                  minLength: 5
                  maxLength: 500
                  description: Motif du retrait de vérification (obligatoire si isVerified=false)
            examples:
              approval:
                summary: Validation du prestataire
                value:
                  isVerified: true
              rejection:
                summary: Rejet du prestataire
                value:
                  isVerified: false
                  rejectionReason: "Vos documents ne sont pas conformes aux exigences de la plateforme"
      responses:
        '200':
          description: Prestataire validé/rejeté
        '400':
          description: Motif de rejet manquant (si isVerified=false sans rejectionReason)

  /admin/providers/{id}/feature:
    put:
      tags:
        - Admin
      summary: Mettre en avant un prestataire
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - isFeatured
              properties:
                isFeatured:
                  type: boolean
      responses:
        '200':
          description: Mise en avant modifiée

  /admin/reviews:
    get:
      tags:
        - Admin
      summary: Liste de tous les avis
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
        - in: query
          name: limit
          schema:
            type: integer
        - in: query
          name: visible
          schema:
            type: boolean
      responses:
        '200':
          description: Liste des avis

  /admin/reviews/{id}/visibility:
    put:
      tags:
        - Admin
      summary: Afficher/masquer un avis
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - isVisible
              properties:
                isVisible:
                  type: boolean
      responses:
        '200':
          description: Visibilité modifiée

  /admin/security-logs:
    get:
      tags:
        - Admin - Sécurité
      summary: Journaux de sécurité
      description: Récupère les logs de sécurité avec filtres optionnels
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 100
        - in: query
          name: eventType
          schema:
            type: string
            enum: [login_success, login_failed, account_locked, otp_verified, otp_failed, honeypot_triggered]
        - in: query
          name: riskLevel
          schema:
            type: string
            enum: [low, medium, high]
        - in: query
          name: startDate
          schema:
            type: string
            format: date
        - in: query
          name: endDate
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Liste des logs de sécurité

  /admin/security-logs/export:
    get:
      tags:
        - Admin - Sécurité
      summary: Exporter les logs en CSV
      description: Télécharge les logs de sécurité au format CSV
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: startDate
          schema:
            type: string
            format: date
        - in: query
          name: endDate
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Fichier CSV téléchargé
          content:
            text/csv:
              schema:
                type: string

  /admin/security-stats:
    get:
      tags:
        - Admin - Sécurité
      summary: Statistiques de sécurité
      description: Dashboard temps réel des événements de sécurité
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Statistiques de sécurité
          content:
            application/json:
              schema:
                type: object
                properties:
                  hourlyFailedAttempts:
                    type: integer
                  dailyFailedAttempts:
                    type: integer
                  highRiskEvents24h:
                    type: integer
                  activeBannedIPs:
                    type: integer
                  topSuspiciousIPs:
                    type: array
                    items:
                      type: object
                      properties:
                        ipAddress:
                          type: string
                        count:
                          type: integer

  /admin/banned-ips:
    get:
      tags:
        - Admin - Sécurité
      summary: Liste des IPs bannies
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Liste des IPs bannies actives
    post:
      tags:
        - Admin - Sécurité
      summary: Bannir une IP
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ipAddress
              properties:
                ipAddress:
                  type: string
                reason:
                  type: string
                duration:
                  type: integer
                  description: Durée en secondes (null = permanent)
      responses:
        '201':
          description: IP bannie

  /admin/banned-ips/{ip}:
    delete:
      tags:
        - Admin - Sécurité
      summary: Débannir une IP
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: ip
          required: true
          schema:
            type: string
      responses:
        '200':
          description: IP débannie
